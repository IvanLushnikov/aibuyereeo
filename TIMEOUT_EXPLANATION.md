# Таймауты и retry при 504

## Таймаут на запрос к n8n

**Основной таймаут:** 10 минут (600000 мс)
- Устанавливается в `CHAT_TIMEOUT_MS` или дефолт 600000
- Это максимальное время ожидания ответа от n8n

## Что происходит при 504

1. **504 Gateway Timeout через ~60 секунд**
2. **n8n продолжает обрабатывать запрос** (может работать 60-120 секунд)
3. **Код получает 504** и делает retry

## Retry при 504

**Всего попыток:** 3 (0, 1, 2)

**Задержки между попытками:**
- После 1-й попытки (504): ждем **30 секунд**
- После 2-й попытки (504): ждем **60 секунд**
- 3-я попытка: финальная

**Временная шкала:**
```
0 сек: Отправка запроса
60 сек: 504 Gateway Timeout
60-90 сек: Ждем 30 секунд
90 сек: Retry #2
150 сек: Если снова 504, ждем 60 секунд
210 сек: Retry #3 (финальная)
```

**Максимальное время:** ~210 секунд (3.5 минуты) + время обработки n8n

## Проблема

При retry отправляется **НОВЫЙ запрос**, а не ожидание результата старого. Это может создать новый execution в n8n.

**Решение:** Нужно использовать polling режим или увеличить таймаут прокси.

