# üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Polling —Ä–µ–∂–∏–º–∞

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å `/api/chat/queue`
2. n8n –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ ‚Üí GET `/api/chat/queue`
3. n8n –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ AI Agent
4. n8n –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí POST `/api/chat/result`
5. –í–∞—à API –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ polling

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ n8n:

### 1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π workflow:

**Schedule Trigger** (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥):
- Cron: `*/5 * * * * *` (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª: 5 —Å–µ–∫—É–Ω–¥

### 2. HTTP Request Node - –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏:

**GET** `http://your-domain.com/api/chat/queue`
- Method: GET
- URL: `http://localhost:3000/api/chat/queue` (–¥–ª—è dev)
- –ò–ª–∏: `https://your-production-domain.com/api/chat/queue`

### 3. IF Node - –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:

–£—Å–ª–æ–≤–∏–µ: `{{ $json.messages.length > 0 }}`

### 4. Loop Over Items - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:

- Input: `{{ $json.messages }}`
- Loop —á–µ—Ä–µ–∑ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞

### 5. AI Agent Node:

- –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ —Ü–∏–∫–ª–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: `{{ $json.message }}`, `{{ $json.history }}`, –∏ —Ç.–¥.

### 6. HTTP Request Node - –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

**POST** `http://your-domain.com/api/chat/result`
- Method: POST
- Body:
```json
{
  "messageId": "{{ $json.id }}",
  "reply": "{{ $json.reply }}",
  "status": "ok",
  "latencyMs": 1234,
  "clientId": "{{ $json.clientId }}",
  "receivedAt": "{{ $json.receivedAt }}"
}
```

## –í–∫–ª—é—á–µ–Ω–∏–µ polling —Ä–µ–∂–∏–º–∞:

–í `.env.local` –¥–æ–±–∞–≤—å—Ç–µ:
```
USE_POLLING=true
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

–ò–ª–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:
```
USE_POLLING=true
NEXT_PUBLIC_BASE_URL=https://your-domain.com
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:

### –û—á–µ—Ä–µ–¥—å (GET /api/chat/queue):
```json
{
  "messages": [
    {
      "id": "msg-123...",
      "clientId": "uuid",
      "message": "–∞–≤—Ç–æ–º–æ–±–∏–ª—å",
      "history": [],
      "meta": {},
      "receivedAt": "2025-11-05T..."
    }
  ]
}
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç (POST /api/chat/result):
```json
{
  "messageId": "msg-123...",
  "reply": "–û—Ç–≤–µ—Ç –æ—Ç AI",
  "status": "ok",
  "latencyMs": 1234,
  "clientId": "uuid",
  "receivedAt": "2025-11-05T..."
}
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ polling:

‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ webhook –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω  
‚úÖ –ú–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É  
‚úÖ –ü—Ä–æ—â–µ –æ—Ç–ª–∞–¥–∫–∞  
‚úÖ –ù–∞–¥–µ–∂–Ω–µ–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

## –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:

‚ö†Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 5 —Å–µ–∫—É–Ω–¥ (–∏–Ω—Ç–µ—Ä–≤–∞–ª polling)  
‚ö†Ô∏è –ù—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –æ—á–µ—Ä–µ–¥—å (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis)

