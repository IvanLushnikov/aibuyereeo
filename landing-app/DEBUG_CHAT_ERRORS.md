# üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ —á–∞—Ç–∞

## –ü—Ä–æ–±–ª–µ–º–∞: –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "–ò–ò‚Äë–±–æ—Ç —Å–µ–π—á–∞—Å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω"

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **Circuit Breaker –æ—Ç–∫—Ä—ã—Ç** (5+ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥)
   - Circuit breaker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ 5 –æ—à–∏–±–æ–∫
   - –ó–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É
   - **–†–µ—à–µ–Ω–∏–µ:** –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1 –º–∏–Ω—É—Ç—É –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

2. **n8n webhook –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404**
   - Workflow –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ n8n
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL webhook
   - **–†–µ—à–µ–Ω–∏–µ:** 
     - –û—Ç–∫—Ä–æ–π—Ç–µ n8n ‚Üí –≤–∞—à workflow
     - –í–∫–ª—é—á–∏—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å "Active" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
     - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL webhook –≤ Production URL

3. **n8n webhook –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 500**
   - –û—à–∏–±–∫–∞ –≤ workflow (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç API –∫–ª—é—á OpenAI)
   - **–†–µ—à–µ–Ω–∏–µ:**
     - –û—Ç–∫—Ä–æ–π—Ç–µ n8n ‚Üí –≤–∫–ª–∞–¥–∫—É "Executions"
     - –ù–∞–π–¥–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π
     - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫–∞—è –Ω–æ–¥–∞ –≤—ã–¥–∞–ª–∞ –æ—à–∏–±–∫—É

4. **–¢–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**
   - n8n —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –æ—Ç–≤–µ—á–∞–µ—Ç (>25 —Å–µ–∫—É–Ω–¥)
   - **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å n8n workflow

5. **n8n –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**
   - –°–µ—Ä–≤–µ—Ä n8n –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
   - **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å `https://n8n.persis.ru`

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:**
   ```bash
   # –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   [API] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ n8n webhook –¥–ª—è clientId: ...
   [N8NClient] –û—à–∏–±–∫–∞ –æ—Ç n8n (—Å—Ç–∞—Ç—É—Å XXX): ...
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ circuit breaker:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ `/api/test-webhook` (GET) - –ø–æ–∫–∞–∂–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   - –ï—Å–ª–∏ circuit breaker –æ—Ç–∫—Ä—ã—Ç, –ø–æ–¥–æ–∂–¥–∏—Ç–µ 1 –º–∏–Ω—É—Ç—É

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ n8n webhook –Ω–∞–ø—Ä—è–º—É—é:**
   ```bash
   curl -X POST "https://n8n.persis.ru/webhook/214d4a37-ae45-4f40-882d-54955ce7ba0a" \
     -H "Content-Type: application/json" \
     -d '{"clientId":"test","message":"—Ç–µ—Å—Ç","history":[],"meta":{"isInitial":true}}'
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```bash
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:
   N8N_WEBHOOK_URL=https://n8n.persis.ru/webhook/...
   ```

### –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ:

1. **–°–±—Ä–æ—Å–∏—Ç—å circuit breaker:**
   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
   - –ò–õ–ò –ø–æ–¥–æ–∂–¥–∏—Ç–µ 1 –º–∏–Ω—É—Ç—É (circuit breaker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä–æ–µ—Ç—Å—è)

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å n8n:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ workflow –∞–∫—Ç–∏–≤–µ–Ω
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ n8n –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network tab ‚Üí –∑–∞–ø—Ä–æ—Å –∫ `/api/chat`
   - –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç API - —Ç–∞–º –±—É–¥–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞

### –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö:

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
- "–ò–ò‚Äë–±–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É." (–≤–º–µ—Å—Ç–æ "–ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω")
- "–ò–ò‚Äë–±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É." (–ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ)

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:

- Circuit breaker –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ 5 –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥
- Retry –ª–æ–≥–∏–∫–∞: 2 –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 1s –∏ 2s
- –¢–∞–π–º–∞—É—Ç: 25 —Å–µ–∫—É–Ω–¥ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `CHAT_TIMEOUT_MS`)

