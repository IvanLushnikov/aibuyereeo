# Инструкции по настройке n8n для работы с оптимизированным API

## 1. Обновление промпта бота

Скопируйте содержимое файла `PROMPT_IMPROVEMENTS.md` в промпт LLM ноды в n8n.

**Важно:** Промпт содержит инструкции по пагинации - бот должен сначала запрашивать 5 позиций, и только при необходимости запрашивать следующие 5.

## 2. Настройка вызовов API с пагинацией

### Вызов `ktru_lookup_plain` (поиск товаров)

**Первый запрос (по умолчанию):**
```json
{
  "productName": "{{ $json.message }}",
  "shape": "plain",
  "page": 1,
  "limit": 5
}
```

**Следующий запрос (если нужно больше позиций):**
```json
{
  "productName": "{{ $json.message }}",
  "shape": "plain",
  "page": 2,
  "limit": 5
}
```

**URL:** `https://your-domain.com/api/ktru-lookup`

**Метод:** POST

**Headers:**
```
Content-Type: application/json
```

### Вызов `ktru_lookup_full` (детали конкретного кода)

**Запрос:**
```json
{
  "code": "{{ $json.code }}",
  "shape": "full"
}
```

**URL:** `https://your-domain.com/api/ktru-lookup`

**Метод:** POST

**Headers:**
```
Content-Type: application/json
```

## 3. Логика работы бота с пагинацией

1. **Первый запрос:** Бот запрашивает `ktru_lookup_plain` с `page=1, limit=5`
2. **Анализ результатов:** Бот проверяет характеристики в первых 5 позициях
3. **Если нужной характеристики нет:** Бот запрашивает `page=2, limit=5`
4. **Продолжение:** При необходимости можно запросить `page=3, limit=5` и т.д.
5. **Выбор кода:** Когда найден подходящий код, бот вызывает `ktru_lookup_full` с конкретным `code`

## 4. Формат ответа от API

### `ktru_lookup_plain` (shape="plain")

```json
{
  "items": [
    "26.20.11.110-00000138 | Диагональ: 15,17 | Разрешение: 1920x1080",
    "26.20.11.110-00000139 | Диагональ: 13,14 | Разрешение: 1366x768"
  ],
  "pagination": {
    "page": 1,
    "limit": 5,
    "hasMore": true
  }
}
```

### `ktru_lookup_full` (shape="full", code="...")

```json
{
  "code": "26.20.11.110-00000138",
  "name": "Ноутбук",
  "okpdName": "Ноутбуки переносные",
  "mandatory_characteristics": [
    {
      "title": "Диагональ экрана",
      "values": ["15", "17"]
    }
  ],
  "optional_characteristics": [
    {
      "title": "Тип матрицы",
      "values": ["IPS", "TN"]
    }
  ]
}
```

## 5. Пример workflow в n8n

```
1. Webhook (получение сообщения)
   ↓
2. LLM нода (обработка с промптом из PROMPT_IMPROVEMENTS.md)
   ↓
3. IF нода (проверка: нужен ли ktru_lookup?)
   ├─ Да → HTTP Request: POST /api/ktru-lookup (page=1, limit=5)
   │   ↓
   │   IF нода (проверка: есть ли нужная характеристика?)
   │   ├─ Нет → HTTP Request: POST /api/ktru-lookup (page=2, limit=5)
   │   └─ Да → Продолжение
   └─ Нет → Продолжение
   ↓
4. IF нода (проверка: нужен ли ktru_lookup_full?)
   ├─ Да → HTTP Request: POST /api/ktru-lookup (shape="full", code="...")
   └─ Нет → Продолжение
   ↓
5. LLM нода (формирование ответа)
   ↓
6. Respond to Webhook (отправка ответа)
```

## 6. Важно!

- **Экономия токенов:** Всегда начинайте с `page=1, limit=5`
- **Пагинация:** Запрашивайте следующую страницу только если нужной характеристики нет в текущих 5 позициях
- **ktru_lookup_full:** Вызывайте ТОЛЬКО когда конкретный код уже найден, передавайте только `code`
- **Ответ от webhook:** Всегда должен содержать поле `reply` с текстом ответа бота

## 7. Проверка работы

После настройки проверьте:
1. Бот запрашивает только 5 позиций в первом запросе
2. Если нужной характеристики нет, запрашивается page=2
3. `ktru_lookup_full` вызывается только с конкретным `code`
4. Ответ от webhook содержит поле `reply`

