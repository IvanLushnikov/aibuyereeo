# Где используется "ИИ‑бот сейчас перегружен"

## Функция: `FALLBACK_REPLY` в `/api/chat/route.ts`

### 1. Rate Limit (строка 124-140)
**Условие:** `isRateLimited(clientId) === true`
**Функция:** `isRateLimited()`
**Ошибка:** Rate limit превышен

### 2. Ошибка добавления в очередь (строка 176)
**Условие:** `queueResponse.ok === false` (при polling режиме)
**Ошибка:** Ошибка добавления в очередь

### 3. Отсутствует N8N_WEBHOOK_URL (строка 246, 252)
**Условие:** `!webhookUrl`
**Ошибка:** `webhook_url_missing`

### 4. Некорректный N8N_WEBHOOK_URL (строка 275, 281)
**Условие:** `new URL(webhookUrl)` выбрасывает исключение
**Ошибка:** `invalid_webhook_url`

### 5. Ошибка валидации payload (строка 326, 332)
**Условие:** `n8nPayloadSchema.parse()` выбрасывает исключение
**Ошибка:** `validation_error`

### 6. Неизвестная ошибка n8n (строка 477)
**Условие:** 
- `n8nError` не содержит известных паттернов
- И `isInitial === false`
**Ошибка:** Любая другая ошибка от n8n

### 7. Дефолтное значение (строка 399)
**Условие:** Используется как начальное значение `replyText`, перезаписывается при успехе

## Про пустые заявки

**Вывод:** Пустые заявки НЕ могут прийти через мой API `/api/feedback` - там есть валидация.

**Источник:** Пустые заявки идут **напрямую в n8n webhook**, минуя мой API.

**Решение:** В n8n workflow нужно добавить IF ноду перед отправкой в Telegram с проверкой:
```
{{ $json.name }} !== "-" && {{ $json.name }} !== "" && {{ $json.email }} !== "-" && {{ $json.email }} !== ""
```

