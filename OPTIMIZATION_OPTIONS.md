# –í–∞—Ä–∏–∞–Ω—Ç—ã —É—Å–∫–æ—Ä–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –±–æ—Ç–∞ –ö–¢–†–£

## üî• –ö—Ä–∏—Ç–∏—á–Ω—ã–µ (–±—ã—Å—Ç—Ä—ã–π —ç—Ñ—Ñ–µ–∫—Ç)

### 1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –ö–¢–†–£** ‚≠ê‚≠ê‚≠ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –¥–µ–ª–∞–µ—Ç –Ω–æ–≤—ã–π –≤—ã–∑–æ–≤ –∫ –≤–Ω–µ—à–Ω–µ–º—É API `ktru.services.persis.ru`
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å Redis/Memory cache –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 10-100 —Ä–∞–∑ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í–´–°–û–ö–ò–ô

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `ktru_lookup_plain` –ø–æ –∫–ª—é—á—É `productName`
- TTL: 24 —á–∞—Å–∞ (–¥–∞–Ω–Ω—ã–µ –ö–¢–†–£ —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è)
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `ktru_lookup_full` –ø–æ –∫–ª—é—á—É `code`
- TTL: 7 –¥–Ω–µ–π

### 2. **–£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞** ‚≠ê‚≠ê‚≠ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–æ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ 4000 —Å–∏–º–≤–æ–ª–æ–≤ = –¥–æ 40KB –∏—Å—Ç–æ—Ä–∏–∏
**–†–µ—à–µ–Ω–∏–µ**: 
- –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π —Å 10 –¥–æ 5-7
- –£–º–µ–Ω—å—à–∏—Ç—å –¥–ª–∏–Ω—É –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å 4000 –¥–æ 2000 —Å–∏–º–≤–æ–ª–æ–≤
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ 20-30% (–º–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è LLM)
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í–´–°–û–ö–ò–ô

### 3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç** ‚≠ê‚≠ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –î–ª–∏–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
**–†–µ—à–µ–Ω–∏–µ**: –°–æ–∫—Ä–∞—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç, —É–±—Ä–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ 10-15%
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –°–†–ï–î–ù–ò–ô

## ‚ö° –í–∞–∂–Ω—ã–µ (—Å—Ä–µ–¥–Ω–∏–π —ç—Ñ—Ñ–µ–∫—Ç)

### 4. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ API –ö–¢–†–£** ‚≠ê‚≠ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –í `ktru-lookup/route.ts` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `cache: "no-store"`
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å HTTP –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ Cache-Control
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ 30-50% –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –°–†–ï–î–ù–ò–ô

### 5. **–£–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä** ‚≠ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–∞–π–º–∞—É—Ç 5 –º–∏–Ω—É—Ç - —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –∂–¥–∞—Ç—å
**–†–µ—à–µ–Ω–∏–µ**: 
- –£–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–æ 60-90 —Å–µ–∫—É–Ω–¥
- –î–æ–±–∞–≤–∏—Ç—å streaming –æ—Ç–≤–µ—Ç–æ–≤ (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å)
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –õ—É—á—à–∏–π UX (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å)
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –°–†–ï–î–ù–ò–ô

### 6. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API –ö–¢–†–£** ‚≠ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∏—Å–∫–æ–≤, –æ–Ω–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
**–†–µ—à–µ–Ω–∏–µ**: –î–µ–ª–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ Promise.all()
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 2-3 —Ä–∞–∑–∞ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–∞—Ö
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ù–ò–ó–ö–ò–ô

## üõ†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ (–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ)

### 7. **Streaming –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç n8n** ‚≠ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥–µ—Ç –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Server-Sent Events (SSE) –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –í–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ–º–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã—à–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–µ–∫—Å—Ç —Å—Ä–∞–∑—É)
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –í—ã—Å–æ–∫–∞—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ù–ò–ó–ö–ò–ô

### 8. **–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** ‚≠ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏—â—É—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–Ω–æ–≤–æ
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ø-100 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –∫—ç—à
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ù–ò–ó–ö–ò–ô

### 9. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–Ω–µ—à–Ω–µ–º—É API –ö–¢–†–£** ‚≠ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –í–Ω–µ—à–Ω–∏–π API –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º
**–†–µ—à–µ–Ω–∏–µ**: 
- –î–æ–±–∞–≤–∏—Ç—å connection pooling
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTP/2
- –î–æ–±–∞–≤–∏—Ç—å retry —Å exponential backoff
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ 10-20%
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ù–ò–ó–ö–ò–ô

### 10. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å LLM** ‚≠ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å (GPT-4), —ç—Ç–æ –∑–∞–º–µ–¥–ª—è–µ—Ç –æ—Ç–≤–µ—Ç
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å (GPT-3.5-turbo, Claude Haiku)
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 2-3 —Ä–∞–∑–∞
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è (—Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ n8n)
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –°–†–ï–î–ù–ò–ô (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GPT-4)

## üìä –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ö–¢–†–£** (—Å–∞–º—ã–π –±–æ–ª—å—à–æ–π —ç—Ñ—Ñ–µ–∫—Ç)
2. **–£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏** (–±—ã—Å—Ç—Ä–æ, –ª–µ–≥–∫–æ)
3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç** (–±—ã—Å—Ç—Ä–æ, –ª–µ–≥–∫–æ)
4. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ API** (–±—ã—Å—Ç—Ä–æ, –ª–µ–≥–∫–æ)
5. **–£–º–µ–Ω—å—à–∏—Ç—å —Ç–∞–π–º–∞—É—Ç + –ø—Ä–æ–≥—Ä–µ—Å—Å** (—Å—Ä–µ–¥–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å)
6. –û—Å—Ç–∞–ª—å–Ω–æ–µ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üí° –ë—ã—Å—Ç—Ä—ã–µ –ø–æ–±–µ–¥—ã (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å)

1. –£–º–µ–Ω—å—à–∏—Ç—å `history.max(10)` –¥–æ `history.max(5)` –≤ `route.ts`
2. –£–º–µ–Ω—å—à–∏—Ç—å `content: z.string().max(4000)` –¥–æ `content: z.string().max(2000)`
3. –î–æ–±–∞–≤–∏—Ç—å `cache: "force-cache"` –≤ –∑–∞–ø—Ä–æ—Å—ã –∫ API –ö–¢–†–£ (—Å TTL)
4. –£–º–µ–Ω—å—à–∏—Ç—å `CHAT_TIMEOUT_MS` —Å 300000 –¥–æ 90000 (90 —Å–µ–∫)

